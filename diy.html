<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gif'r</title>
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="stylesheet" href="bulma.min.css">
  <script src="https://kit.fontawesome.com/e489190e54.js" crossorigin="anonymous"></script>
  <script type="text/javascript">

    window.drawState = {};

    function find(selector) {
      return document.querySelector(selector);
    }

    function resetCanvas(canvas) {
      const ctx = canvas.getContext("2d");
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawStrokeOntoCanvas(canvas, previousPosition, currentPosition) {
      if (!(canvas && previousPosition && currentPosition)) {
        console.log("not enuff stough");
        return;
      }

      const ctx = canvas.getContext("2d");

      ctx.globalCompositeOperation = "source-over"; // layer on top

      ctx.strokeStyle = 'orange';
      ctx.lineWidth = 15;

      ctx.beginPath();       // Start a new path
      ctx.moveTo(previousPosition.x, previousPosition.y);    // Move the pen to (30, 50)
      ctx.lineTo(currentPosition.x, currentPosition.y);  // Draw a line to (150, 100)
      ctx.stroke();          // Render the path
    }

    function initDrawHandlers(canvas) {
      canvas.on = on;

      canvas.on("touchstart", function(e) {
        drawState.penDown = true;
        drawState.previousPosition = getPositionForTouchMove(this, e);
        console.log(e, drawState);
      });

      canvas.on("touchend", e => {
        drawState.penDown = false;
        drawState.previousPosition = null;
        console.log(e, drawState);
      });

      canvas.on("touchmove", function(e) {
        e.preventDefault();
        if (!drawState.penDown) return;

        const currentPosition = getPositionForTouchMove(this, e);
        drawStrokeOntoCanvas(this, drawState.previousPosition, currentPosition);

        drawState.previousPosition = currentPosition;
        console.log(drawState.previousPosition.x, drawState.previousPosition.y);
      });
    }

    function on(eventName, handler) {
      this.addEventListener(eventName, handler);
    }

    function getPositionForTouchMove(canvas, event) {
      const touchEvent = event.targetTouches[0];
      const box = canvas.getBoundingClientRect();

      return {
        x: touchEvent.clientX - box.left,
        y: touchEvent.clientY - box.top
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("App Loaded");

      const containerWidth = find("#main-canvas-container").clientWidth;
      const canvas = find("#main-canvas");

      canvas.height = containerWidth, canvas.width = containerWidth;

      resetCanvas(canvas);
      initDrawHandlers(canvas);
    });
  </script>
</head>
<body>

  <nav class="navbar _is-primary" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="favicon.png" alt="Gif'r" >
      </a>

      <!-- <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a> -->
    </div>
  </nav>

  <!-- <section class="hero is-primary">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">Let's load a Gif to edit!</h1>
      </div>
    </div>
  </section> -->

  <section class="section" style="background-color: #00d1b2; color: #fff;">
    <div class="container">
      <h1 class="title">Draw something!</h1>
      <h2 class="subtitle">
        A simple container to divide your page into <strong>sections</strong>, like the one you're currently reading
      </h2>
      <div id="main-canvas-container">
        <canvas id="main-canvas" width="100%" height="100%">
      </div>
    </div>
  </section>
</body>