<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gif'r</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="dragdealer.css">
  <script src="https://kit.fontawesome.com/e489190e54.js" crossorigin="anonymous"></script>
  <script src="dragdealer.js"></script>
  <script src="gif.js"></script>
  <script src="gif.worker.js"></script>
  <script src="libgif.js"></script>
  <script type="text/javascript">
    function loadGif() {
      const inputValue = document.querySelector("#gif-url").value;
      console.log("loading...", inputValue);

      document.querySelector("#img-preview").src = inputValue;
      window.rub = new SuperGif({ gif: document.querySelector("#img-preview") } );
      rub.load(function(){
        console.log('oh hey, now the gif is loaded');
        rub.pause();
        resetFrames();
        preview();
      });
    }

    function resetFrames() {
      rub.move_to(0);
      window.frames = new Array(rub.get_length()).map(_ => { return {}; });
      updateFrameNumber();
      decorateFrame();
    }

    function updateFrameNumber() {
      document.querySelector("#frame-number").textContent = rub.get_current_frame();
    }

    function nextFrame() {
      rub.move_relative(1);
      updateFrameNumber();
      decorateFrame();
    }

    function prevFrame() {
      rub.move_relative(-1);
      updateFrameNumber();
      decorateFrame();
    }

    function decorateFrame() {
      const text = getText();
      addTextToCanvas(text, rub.get_canvas());

      addOverlayToCanvas(getOverlayImg(), rub.get_canvas(), { sizeRatio:  slider.getValue()[0] });
    }

    function getText() {
      return document.querySelector("#text-for-gif").value;
    }

    function addText() {
      const inputValue = getText();
      console.log(`addText: ${inputValue}`);
      addTextToCanvas(inputValue, rub.get_canvas());
    }

    function addTextToCanvas(text, canvas) {
      var ctx = canvas.getContext("2d");
      ctx.globalCompositeOperation = "source-over"; // layer on top

      ctx.font = "20px Georgia";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";

      ctx.lineWidth = 10;
      ctx.strokeStyle = "black";
      ctx.strokeText(text, canvas.width / 2, canvas.height - 10);

      ctx.fillStyle = "white";
      ctx.fillText(text, canvas.width / 2, canvas.height - 10);
    }

    function preview() {
      window.stopPreviewFlag = false;
      setTimeout(drawNextFrame);
    }

    function stopPreview() {
      window.stopPreviewFlag = true;
    }

    function drawNextFrame() {
      nextFrame();

      if (window.stopPreviewFlag) {
        window.stopPreviewFlag = false;
        return;
      }

      const allFrames = rub.frames();
      const currentFrame = allFrames[rub.get_current_frame()];

      setTimeout(drawNextFrame, currentFrame.delay * 10);
    }

    function hasMoreFrames() {
      return rub.get_current_frame() < (rub.get_length() - 1);
    }

    function generateGif() {
      const gif = new GIF({
        workers: 2,
        quality: 10
      });
      const allFrames = rub.frames();

      stopPreview();
      resetFrames();
      let frames = 0;
      do {
        console.log(`frame count: ${frames}`);
        const currentFrame = allFrames[rub.get_current_frame()];
        const canvas = rub.get_canvas();
        const ctx = canvas.getContext("2d");

        gif.addFrame(ctx.getImageData(0, 0, canvas.width, canvas.height), { copy: true, delay: currentFrame.delay });
        nextFrame();
        frames++;
      }
      while (hasMoreFrames() && frames < 100);

      gif.on('finished', function(blob) {
        const url = URL.createObjectURL(blob);
        console.log("gif ready:", url);
        window.lastRender = blob;

        const renderedImg = document.querySelector("#output-gif");
        renderedImg.src = url;
        renderedImg.crossOrigin = "Anonymous";

        setTimeout(() => renderedImg.scrollIntoView(), 1000);
      });

      console.log("rendering...");
      gif.render();
    }

    function addOverlay() {
      const url = document.querySelector("#overlay-for-gif").value;
      console.log("overlay url:", url);
      const img = getOverlayImg();
      // const img = new Image();
      img.src = url;
      img.crossOrigin = "Anonymous";
      addOverlayToCanvas(img, rub.get_canvas(), {});
    }

    function getOverlayImg() {
      return document.querySelector("#overlay");
    }

    function addOverlayToCanvas(overlay, canvas, options) {
      options = options || {};
      const sizeRatio = options.sizeRatio || 1;
      const ctx = canvas.getContext("2d");
      ctx.globalCompositeOperation = "source-over"; // layer on top

      ctx.drawImage(overlay, 0, 0, overlay.width * sizeRatio, overlay.height * sizeRatio);
    }

    function getOverlaySize() {
      document.querySelector("#overlay-size").value;
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("App Loaded");

      window.slider = new Dragdealer('demo-simple-slider');

      document.querySelector("#use-gif").addEventListener("click", e => loadGif());
      document.querySelector("#prev-gif").addEventListener("click", prevFrame);
      document.querySelector("#next-gif").addEventListener("click", nextFrame);

      document.querySelector("#preview-gif").addEventListener("click", preview);
      document.querySelector("#stop-preview-gif").addEventListener("click", stopPreview);

      document.querySelector("#use-gif").click();
    })
  </script>
</head>
<body>
  <div class="container">
    <form class="form-inline">
      <div class="form-group mb-2">
        <input type="text" class="form-control" id="gif-url" name="gif-url" value="https://media.giphy.com/media/fTbJkvUNa9Hzy/giphy.gif" placeholder="gif url" />
      </div>
      <button class="btn btn-light mb-2" type="button" id="use-gif">Load</button>
    </form>

    <div class="btn-toolbar pb-2" role="toolbar" aria-label="playback controls">
      <div class="btn-group mr-2" role="group" aria-label="button group">
        <button class="btn btn-secondary" type="button" id="prev-gif"><i class="fas fa-chevron-double-left"></i></button>
        <button class="btn btn-secondary" type="button" id="next-gif"><i class="fas fa-chevron-double-right"></i></button>
        <button class="btn btn-secondary" type="button" id="preview-gif"><i class="fas fa-play"></i></button>
        <button class="btn btn-secondary" type="button" id="stop-preview-gif"><i class="fas fa-pause"></i></button>
        <span class="btn btn-secondary">Frame: <span id="frame-number">...</span></span>
      </div>
    </div>
  </div>
  <div class="container p-0">
    <img src="" id="img-preview" />
  </div>
  <div class="container pt-2">
    <form class="form-inline">
      <div class="form-group mb-2">
        <input id="text-for-gif" class="form-control" placeholder="text to put in the gif" value="SMAAAAAASH!" />
      </div>
    </form>

    <form class="form-inline">
      <div class="form-group mb-2">
        <input id="overlay-for-gif" class="form-control" placeholder="https://overlay.com" value="https://avatars1.githubusercontent.com/u/11997716?s=460&u=99f82922435bc454caabb1ca6b904b68eb291eff&v=4" />
      </div>
      <button class="btn btn-light mb-2" type="button" id="add-gif-overlay" onclick="addOverlay()">Add Overlay</button>
    </form>

    <div class="mb-2">
      <div id="demo-simple-slider" class="dragdealer">
        <div class="handle red-bar">drag me</div>
      </div>
    </div>

    <form class="form-inline">
      <button class="btn btn-danger mb-2" type="button" id="render-gif" onclick="generateGif()">Render!</button>
    </form>
  </div>
  <div class="container p-0">
    <img id="overlay" />
  </div>
  <div class="container p-0">
    <h1>Here's your gif hot off the press</h1>
    <div id="generated">
      <img id="output-gif" />
    </div>
  </div>
  <!-- <div>
    <pre>
      Instance methods
      // loading
      load( callback )    Loads the gif specified by the src or rel:animated_src sttributie of the img tag into a canvas element and then calls callback if one is passed
      load_url( src, callback ) Loads the gif file specified in the src argument into a canvas element and then calls callback if one is passed
      // play controls
      play -        Start playing the gif
      pause -       Stop playing the gif
      move_to(i) -    Move to frame i of the gif
      move_relative(i) -  Move i frames ahead (or behind if i < 0)
      // getters
      get_canvas      The canvas element that the gif is playing in. Handy for assigning event handlers to.
      get_playing     Whether or not the gif is currently playing
      get_loading     Whether or not the gif has finished loading/parsing
      get_auto_play   Whether or not the gif is set to play automatically
      get_length      The number of frames in the gif
      get_current_frame The index of the currently displayed frame of the gif
    </pre>
  </div> -->
</body>
</html>