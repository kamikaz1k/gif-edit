<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gif'r</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/e489190e54.js" crossorigin="anonymous"></script>
  <!-- <script src="gif.js"></script> -->
  <script src="libgif.js"></script>
  <script type="text/javascript">
    function loadGif() {
      const inputValue = document.querySelector("#gif-url").value;
      console.log("loading...", inputValue);

      document.querySelector("#img-preview").src = inputValue;
      window.rub = new SuperGif({ gif: document.querySelector("#img-preview") } );
      rub.load(function(){
        console.log('oh hey, now the gif is loaded');
        rub.pause();
        rub.move_to(0);
        resetFrames();
      });
    }

    function resetFrames() {
      window.frames = new Array(rub.get_length());
      updateFrameNumber();
    }

    function updateFrameNumber() {
      document.querySelector("#frame-number").textContent = rub.get_current_frame();
    }

    function nextFrame() {
      rub.move_relative(1);
      updateFrameNumber();
      decorateFrame();
    }

    function prevFrame() {
      rub.move_relative(-1);
      updateFrameNumber();
      decorateFrame();
    }

    function decorateFrame() {
      const text = getText();
      addTextToCanvas(text, rub.get_canvas());
    }

    function getText() {
      return document.querySelector("#text-for-gif").value;
    }

    function addText() {
      const inputValue = getText();
      console.log(`addText: ${inputValue}`);
      addTextToCanvas(inputValue, rub.get_canvas());
    }

    function addTextToCanvas(text, canvas) {
      var ctx = canvas.getContext("2d");
      ctx.globalCompositeOperation = "source-over"; // layer on top

      ctx.font = "20px Georgia";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";

      ctx.lineWidth = 10;
      ctx.strokeStyle = "black";
      ctx.strokeText(text, canvas.width / 2, canvas.height - 10);

      ctx.fillStyle = "white";
      ctx.fillText(text, canvas.width / 2, canvas.height - 10);
    }

    function preview() {
      window.stopPreviewFlag = false;
      setTimeout(drawNextFrame);
    }

    function stopPreview() {
      window.stopPreviewFlag = true;
    }

    function drawNextFrame() {
      nextFrame();

      if (!hasMoreFrames() || window.stopPreviewFlag) {
        window.stopPreviewFlag = true;
        return;
      }

      const allFrames = rub.frames();
      const currentFrame = allFrames[rub.get_current_frame()];

      setTimeout(drawNextFrame, currentFrame.delay * 10);
    }

    function hasMoreFrames() {
      return rub.get_current_frame() < (rub.get_length() - 1);
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("App Loaded");
      document.querySelector("#use-gif").addEventListener("click", e => loadGif());
      document.querySelector("#prev-gif").addEventListener("click", prevFrame);
      document.querySelector("#next-gif").addEventListener("click", nextFrame);
      // document.querySelector("#play-gif").addEventListener("click", () => window.rub && window.rub.play());
      // document.querySelector("#pause-gif").addEventListener("click", () => window.rub && window.rub.pause());
      document.querySelector("#add-text").addEventListener("click", addText);

      document.querySelector("#preview-gif").addEventListener("click", preview);
      document.querySelector("#stop-preview-gif").addEventListener("click", stopPreview);

      document.querySelector("#use-gif").click();
    })
  </script>
</head>
<body>
  <div class="container">
    <form class="form-inline">
      <div class="form-group mb-2">
        <input type="text" class="form-control" id="gif-url" name="gif-url" value="https://media.giphy.com/media/fTbJkvUNa9Hzy/giphy.gif" placeholder="gif url" />
      </div>
      <button class="btn btn-light mb-2" type="button" id="use-gif">Load</button>
    </form>

    <div class="btn-toolbar pb-2" role="toolbar" aria-label="playback controls">
      <div class="btn-group mr-2" role="group" aria-label="button group">
        <button class="btn btn-secondary" type="button" id="prev-gif"><i class="fas fa-chevron-double-left"></i></button>
        <button class="btn btn-secondary" type="button" id="next-gif"><i class="fas fa-chevron-double-right"></i></button>
        <button class="btn btn-secondary" type="button" id="preview-gif"><i class="fas fa-play"></i></button>
        <button class="btn btn-secondary" type="button" id="stop-preview-gif"><i class="fas fa-pause"></i></button>
        <span class="btn btn-secondary">Frame: <span id="frame-number">...</span></span>
      </div>
    </div>
  </div>
  <div>
    <img src="" id="img-preview" />
  </div>
  <div class="container pt-2">
    <form class="form-inline">
      <div class="form-group mb-2">
        <input id="text-for-gif" class="form-control" placeholder="text to put in the gif" />
      </div>
      <button class="btn btn-light mb-1" type="button" id="add-text">Add Text</button>
    </form>
  </div>
  <!-- <div>
    <pre>
      Instance methods
      // loading
      load( callback )    Loads the gif specified by the src or rel:animated_src sttributie of the img tag into a canvas element and then calls callback if one is passed
      load_url( src, callback ) Loads the gif file specified in the src argument into a canvas element and then calls callback if one is passed
      // play controls
      play -        Start playing the gif
      pause -       Stop playing the gif
      move_to(i) -    Move to frame i of the gif
      move_relative(i) -  Move i frames ahead (or behind if i < 0)
      // getters
      get_canvas      The canvas element that the gif is playing in. Handy for assigning event handlers to.
      get_playing     Whether or not the gif is currently playing
      get_loading     Whether or not the gif has finished loading/parsing
      get_auto_play   Whether or not the gif is set to play automatically
      get_length      The number of frames in the gif
      get_current_frame The index of the currently displayed frame of the gif
    </pre>
  </div> -->
</body>
</html>