<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gif'r</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="dragdealer.css">
  <style>
    .hidden {
      display: none;
    }
  </style>
  <script src="https://kit.fontawesome.com/e489190e54.js" crossorigin="anonymous"></script>
  <script src="dragdealer.js"></script>
  <script src="gif.js"></script>
  <script src="gif.worker.js"></script>
  <script src="libgif.js"></script>
  <script type="text/javascript">
    function loadGif() {
      if (window.rub) return;
      const inputValue = document.querySelector("#gif-url").value;
      console.log("loading...", inputValue);

      document.querySelector("#img-preview").src = inputValue;
      window.rub = new SuperGif({ gif: document.querySelector("#img-preview") } );
      rub.load(function(){
        console.log('oh hey, now the gif is loaded');
        rub.pause();
        resetFrames();
        startPreview();
        makeInvisible($("#load-controls"));
        enableEditControls();
      });
    }

    function enableEditControls() {
      makeVisible($("#edit-controls"));
      makeVisible($("#playback-controls"));
    }

    function initSliders() {
      window.slider = new Dragdealer('size-slider', { x: 1, animationCallback: (x, y) => !isPreviewRunning() && refreshFrame() });
      window.overlayVertical = new Dragdealer('vertical-slider', { animationCallback: (x, y) => !isPreviewRunning() && refreshFrame() });
      window.overlayHorizontal = new Dragdealer('horizontal-slider', { animationCallback: (x, y) => !isPreviewRunning() && refreshFrame() });
    }

    function resetFrames() {
      rub.move_to(0);
      window.frames = new Array(rub.get_length()).fill({});
      updateFrameNumber();
      decorateFrame(window.frameByFrame);
    }

    function resetToFirstFrame() {
      rub.move_to(0);
      updateFrameNumber();
    }

    function updateFrameNumber() {
      document.querySelector("#frame-number").textContent = rub.get_current_frame();
    }

    function prevFrameSelected() {
      window.frameByFrame && applyChangesForCurrentFrame();
      prevFrame();
    }
    function nextFrameSelected() {
      window.frameByFrame && applyChangesForCurrentFrame();
      nextFrame();
    }

    function loadNextRenderFrame() {
      nextFrame(window.frameByFrame);
    }

    function nextFrame(frameByFrame) {
      rub.move_relative(1);
      updateFrameNumber();
      decorateFrame(frameByFrame);
    }

    function prevFrame() {
      rub.move_relative(-1);
      updateFrameNumber();
      decorateFrame();
    }

    function decorateFrame(frameByFrame) {
      if (!!frameByFrame) {
        applyForFrame()
      } else {
        applyAllMode();
      }
    }

    function refreshFrame() {
      resetFrame();
      decorateFrame();
    }

    function resetFrame() {
      rub.move_to(rub.get_current_frame());
    }

    function applyChangesForCurrentFrame() {
      const frameIdx = rub.get_current_frame();
      const frameDecorationOptions = {};

      const text = getCaption();
      if (text) {
        frameDecorationOptions.caption = { text: text };
      }

      const imgElement = getOverlayImgElement();
      if (!!imgElement.src) {
        frameDecorationOptions.overlay = {
          sizeRatio:  window.slider.getValue()[0],
          top: window.overlayVertical.getValue()[0],
          left: window.overlayHorizontal.getValue()[0]
        }
      }

      console.log(`overriding frame#${frameIdx} | current: ${JSON.stringify(window.frames[frameIdx])} | new: ${JSON.stringify(frameDecorationOptions)}`);
      window.frames[frameIdx] = frameDecorationOptions;
    }

    function applyForFrame() {
      const frameIdx = rub.get_current_frame();
      const frameDecorationOptions = window.frames[frameIdx];

      if (frameDecorationOptions.overlay && window.slider) {
        addOverlayToCanvas(getOverlayImgElement(), rub.get_canvas(), {
          sizeRatio:  frameDecorationOptions.overlay.sizeRatio,
          top: frameDecorationOptions.overlay.top,
          left: frameDecorationOptions.overlay.left
        });
      }

      if (frameDecorationOptions.caption) {
        const text = frameDecorationOptions.caption.text;
        addTextToCanvas(text, rub.get_canvas());
      }
    }

    function applyAllMode() {
      window.overlayVertical &&
      window.overlayHorizontal &&
      window.slider &&
      addOverlayToCanvas(getOverlayImgElement(), rub.get_canvas(), {
        sizeRatio:  window.slider.getValue()[0],
        top: window.overlayVertical.getValue()[0],
        left: window.overlayHorizontal.getValue()[0]
      });

      addTextToCanvas(getCaption(), rub.get_canvas());
    }

    function getCaption() {
      return getCaptionElement().value;
    }

    function getCaptionElement() {
      return document.querySelector("#text-for-gif");
    }

    function addText() {
      const inputValue = getCaption();
      console.log(`addText: ${inputValue}`);
      addTextToCanvas(inputValue, rub.get_canvas());
    }

    function addTextToCanvas(text, canvas) {
      var ctx = canvas.getContext("2d");
      ctx.globalCompositeOperation = "source-over"; // layer on top

      ctx.font = "20px Georgia";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";

      ctx.lineWidth = 10;
      ctx.strokeStyle = "black";
      ctx.strokeText(text, canvas.width / 2, canvas.height - 10);

      ctx.fillStyle = "white";
      ctx.fillText(text, canvas.width / 2, canvas.height - 10);
    }

    function startPreview() {
      window.previewIsRunning = true;
      setTimeout(drawNextFrame);
    }

    function isPreviewRunning() {
      return window.previewIsRunning;
    }

    function stopPreview() {
      window.previewIsRunning = false;
    }

    function drawNextFrame() {
      nextFrame(window.frameByFrame);

      if (!window.previewIsRunning) {
        return;
      }

      const allFrames = rub.frames();
      const currentFrame = allFrames[rub.get_current_frame()];

      setTimeout(drawNextFrame, currentFrame.delay * 10);
    }

    function hasMoreFrames() {
      return rub.get_current_frame() < (rub.get_length() - 1);
    }

    function generateGif() {
      const gif = new GIF({
        workers: 2,
        quality: 10
      });
      const allFrames = rub.frames();

      stopPreview();
      resetToFirstFrame();
      let frames = 0;
      do {
        console.log(`frame count: ${frames}`);
        const currentFrame = allFrames[rub.get_current_frame()];
        const canvas = rub.get_canvas();
        const ctx = canvas.getContext("2d");

        gif.addFrame(ctx.getImageData(0, 0, canvas.width, canvas.height), { copy: true, delay: currentFrame.delay });
        loadNextRenderFrame();
        frames++;
      }
      while (hasMoreFrames() && frames < 100);

      gif.on('finished', function(blob) {
        const url = URL.createObjectURL(blob);
        console.log("gif ready:", url);
        window.lastRender = blob;

        const renderedImg = document.querySelector("#output-gif");
        renderedImg.src = url;
        renderedImg.crossOrigin = "Anonymous";

        makeVisible(document.querySelector(".render-section"));
        setTimeout(() => renderedImg.scrollIntoView(), 500);
      });

      console.log("rendering...");
      gif.render();
    }

    function makeVisible(element) {
      element.classList.remove("hidden");
    }

    function makeInvisible(element) {
      element.classList.add("hidden");
    }

    function addOverlay(onLoadCallback) {
      const url = document.querySelector("#overlay-for-gif").value;
      console.log("overlay url:", url);
      const img = getOverlayImgElement();

      if (onLoadCallback) {
        img.onload = onLoadCallback;
      }

      img.src = url;
      img.crossOrigin = "Anonymous";
      addOverlayToCanvas(img, rub.get_canvas(), {});
      makeVisible(document.querySelector(".overlay-controls"));

      initSliders();
    }

    function getOverlayImgElement() {
      return document.querySelector("#overlay");
    }

    function addOverlayToCanvas(overlay, canvas, options) {
      options = options || {};
      const sizeRatio = options.sizeRatio || 1;
      const ctx = canvas.getContext("2d");
      ctx.globalCompositeOperation = "source-over"; // layer on top

      const x = (options.left || 0) * canvas.width;
      const y = (options.top || 0) * canvas.height;
      ctx.drawImage(overlay, x, y, overlay.width * sizeRatio, overlay.height * sizeRatio);
    }

    function getOverlaySize() {
      document.querySelector("#overlay-size").value;
    }

    function enableFrameByFrame() {
      stopPreview();
      window.frameByFrame = true;
      console.log(`frameByFrame status: ${frameByFrame}`);
      resetFrames();
      setTimeout(() => { resetToFirstFrame(); refreshFrame(); }, 500);
    }

    function $(selector) {
      return document.querySelector(selector);
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.log("App Loaded");

      document.querySelector("#use-gif").addEventListener("click", e => loadGif());
      document.querySelector("#prev-gif").addEventListener("click", prevFrameSelected);
      document.querySelector("#next-gif").addEventListener("click", nextFrameSelected);

      document.querySelector("#preview-gif").addEventListener("click", startPreview);
      document.querySelector("#stop-preview-gif").addEventListener("click", stopPreview);

      $("#frame-by-frame").addEventListener("click", enableFrameByFrame);

      // TODO: REMOVE
      document.querySelector("#use-gif").click();

      $("#add-gif-overlay").addEventListener("click", () => { addOverlay(refreshFrame); });

      getCaptionElement().addEventListener("keydown", () => { console.log("keydown!"); setTimeout(refreshFrame) });
    })
  </script>
</head>
<body>
  <div class="container">
    <form class="form-inline" id="load-controls">
      <div class="form-group mb-2">
        <input type="text" class="form-control" id="gif-url" name="gif-url" value="https://media.giphy.com/media/fTbJkvUNa9Hzy/giphy.gif" placeholder="gif url" />
      </div>
      <button class="btn btn-light mb-2" type="button" id="use-gif">Load</button>
    </form>

    <div class="btn-toolbar pb-2 hidden" role="toolbar" aria-label="playback controls" id="playback-controls">
      <div class="btn-group mr-2" role="group" aria-label="button group">
        <button class="btn btn-secondary" type="button" id="prev-gif"><i class="fas fa-chevron-double-left"></i></button>
        <button class="btn btn-secondary" type="button" id="next-gif"><i class="fas fa-chevron-double-right"></i></button>
        <button class="btn btn-secondary" type="button" id="preview-gif"><i class="fas fa-play"></i></button>
        <button class="btn btn-secondary" type="button" id="stop-preview-gif"><i class="fas fa-pause"></i></button>
        <span class="btn btn-secondary">Frame: <span id="frame-number">...</span></span>
      </div>
    </div>
  </div>
  <div class="container p-0">
    <img crossorigin="Anonymous" id="img-preview" />
  </div>
  <div class="container pt-2 hidden" id="edit-controls">
    <div>
      <button class="btn btn-warning mb-2 btn-block" type="button" id="frame-by-frame">Enable frame by frame mode*</button>
      <p class="text-center">*allows you to edit each frame individually</p>
    </div>

    <div class="input-group mb-2">
      <input type="text" id="text-for-gif" class="form-control" placeholder="text to put in the gif" value="SMAAAAAASH!" aria-label="gif caption" aria-describedby="basic-caption">
      <div class="input-group-append">
        <span class="input-group-text" id="basic-caption">Caption</span>
      </div>
    </div>

    <form class="form-inline">
      <div class="form-group mb-2">
        <input id="overlay-for-gif" class="form-control" placeholder="https://overlay.com" value="https://avatars1.githubusercontent.com/u/11997716?s=460&u=99f82922435bc454caabb1ca6b904b68eb291eff&v=4" />
      </div>
      <button class="btn btn-light mb-2" type="button" id="add-gif-overlay">Add Overlay</button>
    </form>

    <div class="mb-2 overlay-controls hidden">
      <div id="size-slider" class="dragdealer">
        <div class="handle red-bar">size</div>
      </div>

      <div id="vertical-slider" class="dragdealer">
        <div class="handle red-bar">up/down</div>
      </div>

      <div id="horizontal-slider" class="dragdealer">
        <div class="handle red-bar">left/right</div>
      </div>
    </div>

    <form class="form-inline">
      <button class="btn btn-danger mb-2 btn-block" type="button" id="render-gif" onclick="generateGif()">Render!</button>
    </form>
  </div>

  <div class="container p-0">
    <img crossorigin="Anonymous" class="hidden" id="overlay" />
  </div>

  <div class="container p-0 render-section hidden">
    <h1>Here's your gif hot off the press</h1>
    <div id="generated">
      <img crossorigin="Anonymous" id="output-gif" />
    </div>
    <h1>Save the image directly, you can not hotlink it!</h1>
    <h2>Remember to like follow subscribe</h2>
  </div>
</body>
</html>